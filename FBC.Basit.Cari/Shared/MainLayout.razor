@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@inject AuthenticationStateProvider AuthenticationStateProvider

@inherits LayoutComponentBase

<PageTitle>FBC.Basit.Cari</PageTitle>

@*<button @onclick="GetClaimsPrincipalData">Get ClaimsPrincipal Data</button>
    @if (_claims.Count() > 0)
    {
    <ul>
    @foreach (var claim in _claims)
    {
    <li>@claim.Type: @claim.Value</li>
    }
    </ul>
    }

    <p>@_surnameMessage</p>
*@

<div class="page">
    <div class="sidebar">
        <NavMenu />
    </div>

    <main>
        <AuthorizeView>
            <Authorized>
                <div class="top-row px-4">
                    <span class="badge rounded-pill bg-primary">@userTitle</span>
                    <a class="badge rounded-pill bg-dark" href="/Logout">Çıkış</a>
                </div>
            </Authorized>
            <NotAuthorized>
                <div class="top-row px-4">
                    <a href="/Login">Giriş</a>
                </div>
            </NotAuthorized>
        </AuthorizeView>


        <article class="content px-4">
            @Body
        </article>
    </main>
</div>


@code {
    private string userTitle = "";

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity.IsAuthenticated)
        {
            string name = user.FindFirst(c => c.Type == ClaimTypes.Name)?.Value;
            string surname = user.FindFirst(c => c.Type == ClaimTypes.Surname)?.Value;
            string userName = user.FindFirst(c => c.Type == ClaimTypes.Sid)?.Value;
            userTitle = $"{name} {surname} ({userName}) ";
        }
        else
        {
            userTitle = "";
        }
        //InvokeAsync(() => StateHasChanged());
        StateHasChanged();

    }

    //private string _authMessage;
    //private string _surnameMessage;
    //private IEnumerable<Claim> _claims = Enumerable.Empty<Claim>();

    //private async Task GetClaimsPrincipalData()
    //{
    //    var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
    //    var user = authState.User;

    //    if (user.Identity.IsAuthenticated)
    //    {
    //        _authMessage = $"{user.Identity.Name} is authenticated.";
    //        _claims = user.Claims;
    //        _surnameMessage =
    //            $"Surname: {user.FindFirst(c => c.Type == ClaimTypes.Surname)?.Value}";
    //    }
    //    else
    //    {
    //        _authMessage = "The user is NOT authenticated.";
    //    }
    //}


}